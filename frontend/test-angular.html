<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦ GCP Storage JSON è®€å– (Angular é¢¨æ ¼)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .stats {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .stats h2 {
            margin-bottom: 15px;
            color: #1976d2;
        }
        .stats p {
            margin: 8px 0;
            font-size: 16px;
        }
        .zip-selector {
            margin: 20px 0;
        }
        .zip-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .zip-selector select {
            width: 100%;
            max-width: 300px;
            padding: 10px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 4px;
        }
        .zip-details {
            margin-top: 30px;
            padding: 25px;
            background: #fafafa;
            border-radius: 8px;
        }
        .zillow-data {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .zillow-data h3 {
            color: #2e7d32;
            margin-bottom: 15px;
        }
        .indices {
            background: #f3e5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .indices h3 {
            color: #7b1fa2;
            margin-bottom: 15px;
        }
        .index-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e1bee7;
        }
        .index-item:last-child {
            border-bottom: none;
        }
        .index-name {
            font-weight: 500;
            color: #4a148c;
        }
        .index-value {
            font-size: 20px;
            font-weight: bold;
            color: #6a1b9a;
        }
        .index-bar {
            width: 100%;
            height: 8px;
            background: #e1bee7;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }
        .index-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #9c27b0, #7b1fa2);
            transition: width 0.3s ease;
        }
        .crime-stats {
            background: #fff3e0;
            padding: 20px;
            border-radius: 8px;
        }
        .crime-stats h3 {
            color: #e65100;
            margin-bottom: 15px;
        }
        .crime-stats h4 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #666;
        }
        ul {
            list-style: none;
            padding: 0;
        }
        li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .price {
            font-size: 24px;
            font-weight: bold;
            color: #2e7d32;
        }
        .change-positive {
            color: #4caf50;
        }
        .change-negative {
            color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ  DC Crime & Zillow è³‡æ–™æ¸¬è©¦</h1>
        
        <div id="loading" class="loading">
            <p>è¼‰å…¥è³‡æ–™ä¸­...</p>
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="content" style="display: none;">
            <!-- çµ±è¨ˆè³‡è¨Š -->
            <div class="stats">
                <h2>ğŸ“Š çµ±è¨ˆè³‡è¨Š</h2>
                <p>ç¸½ ZIP Code æ•¸: <strong id="total-zipcodes">-</strong></p>
                <p>ç¸½çŠ¯ç½ªè¨˜éŒ„æ•¸: <strong id="total-crimes">-</strong></p>
                <p>ç¸½ Zillow è¨˜éŒ„: <strong id="total-zillow">-</strong></p>
                <p>è³‡æ–™ç”Ÿæˆæ™‚é–“: <strong id="generated-at">-</strong></p>
            </div>
            
            <!-- HCI æ¬Šé‡èª¿æ•´ -->
            <div class="hci-controls" style="background: #f0f4f8; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3>ğŸšï¸ HCI æ¬Šé‡èª¿æ•´ï¼ˆè«–æ–‡å…¬å¼ï¼‰</h3>
                <div style="margin: 15px 0;">
                    <label>æˆé•·æ¬Šé‡ (w1): <strong id="w1Value">60%</strong></label>
                    <input type="range" id="w1Slider" min="0" max="100" value="60" 
                           style="width: 100%; max-width: 400px;">
                </div>
                <div style="margin: 15px 0;">
                    <label>å®‰å…¨æ¬Šé‡ (w2): <strong id="w2Value">40%</strong></label>
                    <input type="range" id="w2Slider" min="0" max="100" value="40" 
                           style="width: 100%; max-width: 400px;">
                </div>
                <div style="margin: 15px 0;">
                    <label>YoY æ¬Šé‡ (Î±): <strong id="alphaValue">50%</strong></label>
                    <input type="range" id="alphaSlider" min="0" max="100" value="50" 
                           style="width: 100%; max-width: 400px;">
                    <small style="color: #666;">èª¿æ•´ MoM å’Œ YoY çš„æ¬Šé‡ï¼ˆ0 = åªä½¿ç”¨ MoM, 100 = åªä½¿ç”¨ YoYï¼‰</small>
                </div>
                <button onclick="recalculateAllHCI()" 
                        style="padding: 10px 20px; background: #7b1fa2; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    é‡æ–°è¨ˆç®—æ‰€æœ‰ ZIP Code çš„ HCI
                </button>
            </div>
            
            <!-- æŒ‡æ•¸é¸æ“‡å™¨ -->
            <div class="index-selector" style="margin: 20px 0;">
                <label for="indexSelect">é¸æ“‡é¡¯ç¤ºçš„æŒ‡æ•¸:</label>
                <select id="indexSelect" style="width: 100%; max-width: 300px; padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 4px;">
                    <option value="hci">HCI (è«–æ–‡å…¬å¼ï¼Œå¯èª¿æ•´æ¬Šé‡)</option>
                    <option value="quality_of_life">ç”Ÿæ´»å“è³ªæŒ‡æ•¸</option>
                    <option value="safety">å®‰å…¨æŒ‡æ•¸</option>
                    <option value="affordability">å¯è² æ“”æ€§æŒ‡æ•¸</option>
                    <option value="investment">æŠ•è³‡åƒ¹å€¼æŒ‡æ•¸</option>
                </select>
            </div>
            
            <!-- ZIP Code é¸æ“‡å™¨ -->
            <div class="zip-selector">
                <label for="zipSelect">é¸æ“‡ ZIP Code:</label>
                <select id="zipSelect">
                    <option value="">-- è«‹é¸æ“‡ ZIP Code --</option>
                </select>
            </div>
            
            <!-- ZIP Code è©³ç´°è³‡æ–™ -->
            <div id="zipDetails" class="zip-details" style="display: none;">
                <h2>ğŸ“ ZIP Code <span id="selectedZip"></span> è©³ç´°è³‡æ–™</h2>
                
                <!-- Zillow è³‡æ–™ -->
                <div id="zillowData" class="zillow-data" style="display: none;">
                    <h3>ğŸ’° æˆ¿åƒ¹è³‡è¨Š</h3>
                    <p class="price" id="currentPrice">-</p>
                    <p>æœˆè®ŠåŒ– (MOM): <span id="mom"></span></p>
                    <p>å¹´è®ŠåŒ– (YOY): <span id="yoy"></span></p>
                    <p>å€åŸŸ: <span id="regionName"></span></p>
                </div>
                
                <!-- HCI åˆ†æ•¸ï¼ˆè«–æ–‡å…¬å¼ï¼‰ -->
                <div id="hciData" class="indices" style="display: none; background: #e8eaf6;">
                    <h3>ğŸ“Š HCI (Housing-Crime Index) - è«–æ–‡å…¬å¼</h3>
                    <div class="index-item">
                        <span class="index-name">HCI åˆ†æ•¸</span>
                        <span class="index-value" id="hciScore">-</span>
                    </div>
                    <div class="index-bar"><div class="index-bar-fill" id="hciBar" style="width: 0%; background: linear-gradient(90deg, #3f51b5, #5c6bc0);"></div></div>
                    
                    <div class="index-item">
                        <span class="index-name">æˆé•·æŒ‡æ¨™ (G_z)</span>
                        <span class="index-value" id="growthIndicator">-</span>
                    </div>
                    <div class="index-bar"><div class="index-bar-fill" id="growthBar" style="width: 0%"></div></div>
                    
                    <div class="index-item">
                        <span class="index-name">å®‰å…¨æŒ‡æ¨™ (1 - C_z)</span>
                        <span class="index-value" id="safetyIndicatorHCI">-</span>
                    </div>
                    <div class="index-bar"><div class="index-bar-fill" id="safetyBarHCI" style="width: 0%"></div></div>
                    
                    <div class="index-item" id="crimeRateItem" style="display: none;">
                        <span class="index-name">çŠ¯ç½ªç‡ï¼ˆæ¯ 1000 å±…æ°‘ï¼‰</span>
                        <span class="index-value" id="crimeRatePer1000">-</span>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #fff; border-radius: 4px; font-size: 12px; color: #666;">
                        <strong>æ¬Šé‡è¨­å®š:</strong><br>
                        æˆé•·æ¬Šé‡ (w1): <span id="currentW1">50%</span><br>
                        å®‰å…¨æ¬Šé‡ (w2): <span id="currentW2">50%</span><br>
                        YoY æ¬Šé‡ (Î±): <span id="currentAlpha">50%</span>
                    </div>
                </div>
                
                <!-- Index åˆ†æ•¸ï¼ˆç¾æœ‰æŒ‡æ•¸ï¼‰ -->
                <div id="indicesData" class="indices" style="display: none;">
                    <h3>ğŸ“Š ç¶œåˆæŒ‡æ•¸</h3>
                    <div class="index-item">
                        <span class="index-name">ç”Ÿæ´»å“è³ªæŒ‡æ•¸</span>
                        <span class="index-value" id="qualityOfLifeIndex">-</span>
                    </div>
                    <div class="index-bar"><div class="index-bar-fill" id="qualityOfLifeBar" style="width: 0%"></div></div>
                    
                    <div class="index-item">
                        <span class="index-name">å®‰å…¨æŒ‡æ•¸</span>
                        <span class="index-value" id="safetyIndex">-</span>
                    </div>
                    <div class="index-bar"><div class="index-bar-fill" id="safetyBar" style="width: 0%"></div></div>
                    
                    <div class="index-item">
                        <span class="index-name">æŠ•è³‡åƒ¹å€¼æŒ‡æ•¸</span>
                        <span class="index-value" id="investmentIndex">-</span>
                    </div>
                    <div class="index-bar"><div class="index-bar-fill" id="investmentBar" style="width: 0%"></div></div>
                    
                    <div class="index-item" id="affordabilityItem" style="display: none;">
                        <span class="index-name">å¯è² æ“”æ€§æŒ‡æ•¸</span>
                        <span class="index-value" id="affordabilityIndex">-</span>
                    </div>
                    <div class="index-bar" id="affordabilityBar" style="display: none;"><div class="index-bar-fill" id="affordabilityBarFill" style="width: 0%"></div></div>
                    
                    <div class="index-item">
                        <span class="index-name">çŠ¯ç½ªé¢¨éšªæŒ‡æ•¸</span>
                        <span class="index-value" id="crimeIndex">-</span>
                    </div>
                    <div class="index-bar"><div class="index-bar-fill" id="crimeBar" style="width: 0%"></div></div>
                </div>
                
                <!-- Crime çµ±è¨ˆ -->
                <div class="crime-stats">
                    <h3>ğŸš¨ çŠ¯ç½ªçµ±è¨ˆ</h3>
                    <p>ç¸½çŠ¯ç½ªæ•¸: <strong id="totalCrimes">-</strong></p>
                    
                    <h4>æŒ‰çŠ¯ç½ªé¡å‹ï¼ˆå‰ 10 åï¼‰</h4>
                    <ul id="offenseList"></ul>
                    
                    <h4>æŒ‰æ™‚æ®µ</h4>
                    <ul id="shiftList"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const PUBLIC_URL = 'https://storage.googleapis.com/dc-crime-data-zhangxuanqi-1762814591/data/dc_crime_zillow_combined.json';
        
        let allData = null;
        let currentHCIWeights = { w1: 0.6, w2: 0.4, alpha: 0.5 };
        let allHCIResults = {};
        
        // HCI Calculator (è«–æ–‡å…¬å¼)
        class HCICalculator {
            normalizeTo01(value, minVal, maxVal) {
                if (maxVal === minVal) return 0.5;
                const normalized = (value - minVal) / (maxVal - minVal);
                return Math.max(0, Math.min(1, normalized));
            }
            
            calculateGrowthIndicator(momRate, yoyRate, ranges, alpha) {
                if (momRate === null || yoyRate === null || 
                    ranges.min_mom === null || ranges.max_mom === null ||
                    ranges.min_yoy === null || ranges.max_yoy === null) {
                    return 0.0;
                }
                const normalizedMom = this.normalizeTo01(momRate, ranges.min_mom, ranges.max_mom);
                const normalizedYoy = this.normalizeTo01(yoyRate, ranges.min_yoy, ranges.max_yoy);
                return alpha * normalizedYoy + (1 - alpha) * normalizedMom;
            }
            
            calculateCrimeIndicator(crimeCount, population, ranges) {
                let crimeRate = null;
                if (population !== null && population > 0 && 
                    ranges.min_crime_rate !== null && ranges.max_crime_rate !== null) {
                    crimeRate = (crimeCount / population) * 1000;
                    return this.normalizeTo01(crimeRate, ranges.min_crime_rate, ranges.max_crime_rate);
                } else {
                    return this.normalizeTo01(crimeCount, ranges.min_crime_count, ranges.max_crime_count);
                }
            }
            
            calculateHCI(zipData, params) {
                const { w1, w2, alpha } = params;
                const ranges = zipData.hci.ranges;
                const momRate = zipData.zillow_data?.mom ?? null;
                const yoyRate = zipData.zillow_data?.yoy ?? null;
                const crimeCount = zipData.crime_stats.total_crimes;
                const population = zipData.census_data?.total_population ?? null;
                
                const growthIndicator = this.calculateGrowthIndicator(momRate, yoyRate, ranges, alpha);
                const crimeIndicator = this.calculateCrimeIndicator(crimeCount, population, ranges);
                const safetyIndicator = 1 - crimeIndicator;
                
                let hciScore;
                if (momRate !== null && yoyRate !== null) {
                    hciScore = w1 * growthIndicator + w2 * safetyIndicator;
                } else if (crimeCount > 0) {
                    hciScore = w2 * safetyIndicator;
                } else {
                    hciScore = 0.0;
                }
                
                let crimeRatePer1000 = null;
                if (population !== null && population > 0) {
                    crimeRatePer1000 = (crimeCount / population) * 1000;
                }
                
                return {
                    hci_score: hciScore,
                    hci_score_100: Math.round(hciScore * 100 * 100) / 100,
                    growth_indicator: growthIndicator,
                    growth_indicator_100: Math.round(growthIndicator * 100 * 100) / 100,
                    crime_indicator: crimeIndicator,
                    crime_indicator_100: Math.round(crimeIndicator * 100 * 100) / 100,
                    safety_indicator: safetyIndicator,
                    safety_indicator_100: Math.round(safetyIndicator * 100 * 100) / 100,
                    crime_rate_per_1000: crimeRatePer1000 ? Math.round(crimeRatePer1000 * 100) / 100 : null
                };
            }
            
            calculateAllHCI(data, params) {
                const results = {};
                for (const zipCode in data) {
                    results[zipCode] = this.calculateHCI(data[zipCode], params);
                }
                return results;
            }
        }
        
        const hciCalculator = new HCICalculator();
        
        // è¼‰å…¥è³‡æ–™
        async function loadData() {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const contentEl = document.getElementById('content');
            
            try {
                const response = await fetch(PUBLIC_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                allData = await response.json();
                
                // é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š
                document.getElementById('total-zipcodes').textContent = allData.metadata.total_zipcodes;
                document.getElementById('total-crimes').textContent = allData.metadata.total_crimes.toLocaleString();
                document.getElementById('total-zillow').textContent = allData.metadata.total_zillow_records;
                document.getElementById('generated-at').textContent = new Date(allData.metadata.generated_at).toLocaleString('zh-TW');
                
                // è¼‰å…¥ ZIP Code åˆ—è¡¨
                const zipCodes = Object.keys(allData.data).sort();
                const zipSelect = document.getElementById('zipSelect');
                zipCodes.forEach(zip => {
                    const option = document.createElement('option');
                    option.value = zip;
                    option.textContent = zip;
                    zipSelect.appendChild(option);
                });
                
                // ç›£è½é¸æ“‡è®ŠåŒ–
                zipSelect.addEventListener('change', (e) => {
                    const selectedZip = e.target.value;
                    if (selectedZip) {
                        loadZipCodeData(selectedZip);
                    } else {
                        document.getElementById('zipDetails').style.display = 'none';
                    }
                });
                
                // ç›£è½æŒ‡æ•¸é¸æ“‡è®ŠåŒ–
                const indexSelect = document.getElementById('indexSelect');
                indexSelect.addEventListener('change', (e) => {
                    const selectedZip = document.getElementById('zipSelect').value;
                    if (selectedZip) {
                        loadZipCodeData(selectedZip);
                    }
                });
                
                // è¨­å®š HCI æ¬Šé‡æ»‘æ¡¿
                setupHCIControls();
                
                // è¨ˆç®—æ‰€æœ‰ ZIP Code çš„ HCIï¼ˆä½¿ç”¨é è¨­æ¬Šé‡ï¼‰
                recalculateAllHCI();
                
                // éš±è—è¼‰å…¥ï¼Œé¡¯ç¤ºå…§å®¹
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
                
                console.log('âœ… è³‡æ–™è¼‰å…¥æˆåŠŸï¼', allData);
                
            } catch (error) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                errorEl.textContent = `âŒ è¼‰å…¥å¤±æ•—: ${error.message}`;
                console.error('è¼‰å…¥å¤±æ•—:', error);
            }
        }
        
        // è¼‰å…¥ç‰¹å®š ZIP Code çš„è³‡æ–™
        function loadZipCodeData(zipCode) {
            const zipData = allData.data[zipCode];
            if (!zipData) return;
            
            document.getElementById('selectedZip').textContent = zipCode;
            document.getElementById('totalCrimes').textContent = zipData.crime_stats.total_crimes;
            
            // Zillow è³‡æ–™
            const zillowEl = document.getElementById('zillowData');
            if (zipData.zillow_data) {
                zillowEl.style.display = 'block';
                document.getElementById('currentPrice').textContent = 
                    '$' + zipData.zillow_data.current_price.toLocaleString('en-US', {maximumFractionDigits: 0});
                
                const mom = zipData.zillow_data.mom * 100;
                const yoy = zipData.zillow_data.yoy * 100;
                
                document.getElementById('mom').innerHTML = 
                    `<span class="${mom >= 0 ? 'change-positive' : 'change-negative'}">${mom >= 0 ? '+' : ''}${mom.toFixed(2)}%</span>`;
                document.getElementById('yoy').innerHTML = 
                    `<span class="${yoy >= 0 ? 'change-positive' : 'change-negative'}">${yoy >= 0 ? '+' : ''}${yoy.toFixed(2)}%</span>`;
                document.getElementById('regionName').textContent = zipData.zillow_data.region_name || '-';
            } else {
                zillowEl.style.display = 'none';
            }
            
            // æ ¹æ“šé¸æ“‡çš„æŒ‡æ•¸é¡å‹é¡¯ç¤º
            const selectedIndex = document.getElementById('indexSelect').value;
            
            if (selectedIndex === 'hci') {
                // é¡¯ç¤º HCIï¼ˆè«–æ–‡å…¬å¼ï¼‰
                displayHCI(zipCode, zipData);
                document.getElementById('indicesData').style.display = 'none';
            } else {
                // é¡¯ç¤ºç¾æœ‰æŒ‡æ•¸
                displayIndices(zipData);
                document.getElementById('hciData').style.display = 'none';
            }
            
            // çŠ¯ç½ªé¡å‹åˆ—è¡¨
            const offenseList = Object.entries(zipData.crime_stats.by_offense)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            const offenseEl = document.getElementById('offenseList');
            offenseEl.innerHTML = offenseList.map(([offense, count]) => 
                `<li>${offense}: <strong>${count}</strong> ç­†</li>`
            ).join('');
            
            // æ™‚æ®µåˆ—è¡¨
            const shiftList = Object.entries(zipData.crime_stats.by_shift)
                .sort((a, b) => b[1] - a[1]);
            const shiftEl = document.getElementById('shiftList');
            shiftEl.innerHTML = shiftList.map(([shift, count]) => 
                `<li>${shift}: <strong>${count}</strong> ç­†</li>`
            ).join('');
            
            document.getElementById('zipDetails').style.display = 'block';
        }
        
        // é¡¯ç¤º HCIï¼ˆè«–æ–‡å…¬å¼ï¼‰
        function displayHCI(zipCode, zipData) {
            const hciEl = document.getElementById('hciData');
            if (!zipData.hci || !zipData.hci.ranges) {
                hciEl.style.display = 'none';
                return;
            }
            
            // ä½¿ç”¨ç•¶å‰æ¬Šé‡è¨ˆç®— HCI
            const hciResult = hciCalculator.calculateHCI(zipData, currentHCIWeights);
            
            // é¡¯ç¤º HCI åˆ†æ•¸
            document.getElementById('hciScore').textContent = hciResult.hci_score_100.toFixed(1);
            document.getElementById('hciBar').style.width = hciResult.hci_score_100 + '%';
            
            // é¡¯ç¤ºæˆé•·æŒ‡æ¨™
            document.getElementById('growthIndicator').textContent = hciResult.growth_indicator_100.toFixed(1);
            document.getElementById('growthBar').style.width = hciResult.growth_indicator_100 + '%';
            
            // é¡¯ç¤ºå®‰å…¨æŒ‡æ¨™
            document.getElementById('safetyIndicatorHCI').textContent = hciResult.safety_indicator_100.toFixed(1);
            document.getElementById('safetyBarHCI').style.width = hciResult.safety_indicator_100 + '%';
            
            // é¡¯ç¤ºçŠ¯ç½ªç‡
            if (hciResult.crime_rate_per_1000 !== null) {
                document.getElementById('crimeRateItem').style.display = 'flex';
                document.getElementById('crimeRatePer1000').textContent = hciResult.crime_rate_per_1000.toFixed(2);
            } else {
                document.getElementById('crimeRateItem').style.display = 'none';
            }
            
            // é¡¯ç¤ºç•¶å‰æ¬Šé‡
            document.getElementById('currentW1').textContent = (currentHCIWeights.w1 * 100).toFixed(0) + '%';
            document.getElementById('currentW2').textContent = (currentHCIWeights.w2 * 100).toFixed(0) + '%';
            document.getElementById('currentAlpha').textContent = (currentHCIWeights.alpha * 100).toFixed(0) + '%';
            
            hciEl.style.display = 'block';
        }
        
        // é¡¯ç¤ºç¾æœ‰æŒ‡æ•¸
        function displayIndices(zipData) {
            const indicesEl = document.getElementById('indicesData');
            if (!zipData.indices) {
                indicesEl.style.display = 'none';
                return;
            }
            
            // ç”Ÿæ´»å“è³ªæŒ‡æ•¸
            const qolIndex = zipData.indices.quality_of_life_index;
            document.getElementById('qualityOfLifeIndex').textContent = qolIndex.toFixed(1);
            document.getElementById('qualityOfLifeBar').style.width = qolIndex + '%';
            
            // å®‰å…¨æŒ‡æ•¸
            const safetyIndex = zipData.indices.safety_index;
            document.getElementById('safetyIndex').textContent = safetyIndex.toFixed(1);
            document.getElementById('safetyBar').style.width = safetyIndex + '%';
            
            // æŠ•è³‡åƒ¹å€¼æŒ‡æ•¸
            const investmentIndex = zipData.indices.investment_index;
            document.getElementById('investmentIndex').textContent = investmentIndex.toFixed(1);
            document.getElementById('investmentBar').style.width = investmentIndex + '%';
            
            // å¯è² æ“”æ€§æŒ‡æ•¸
            if (zipData.indices.affordability_index !== null && zipData.indices.affordability_index !== undefined) {
                document.getElementById('affordabilityItem').style.display = 'flex';
                document.getElementById('affordabilityBar').style.display = 'block';
                const affordabilityIndex = zipData.indices.affordability_index;
                document.getElementById('affordabilityIndex').textContent = affordabilityIndex.toFixed(1);
                document.getElementById('affordabilityBarFill').style.width = affordabilityIndex + '%';
            } else {
                document.getElementById('affordabilityItem').style.display = 'none';
                document.getElementById('affordabilityBar').style.display = 'none';
            }
            
            // çŠ¯ç½ªé¢¨éšªæŒ‡æ•¸
            const crimeIndex = zipData.indices.crime_index;
            document.getElementById('crimeIndex').textContent = crimeIndex.toFixed(1);
            document.getElementById('crimeBar').style.width = crimeIndex + '%';
            
            indicesEl.style.display = 'block';
        }
        
        // è¨­å®š HCI æ¬Šé‡æ§åˆ¶
        function setupHCIControls() {
            const w1Slider = document.getElementById('w1Slider');
            const w2Slider = document.getElementById('w2Slider');
            const alphaSlider = document.getElementById('alphaSlider');
            
            // æ›´æ–° w1
            w1Slider.addEventListener('input', (e) => {
                const w1 = parseInt(e.target.value) / 100;
                const w2 = 1 - w1;
                currentHCIWeights.w1 = w1;
                currentHCIWeights.w2 = w2;
                
                document.getElementById('w1Value').textContent = (w1 * 100).toFixed(0) + '%';
                document.getElementById('w2Value').textContent = (w2 * 100).toFixed(0) + '%';
                w2Slider.value = (w2 * 100).toFixed(0);
                
                // å¦‚æœç•¶å‰é¸æ“‡çš„æ˜¯ HCIï¼Œæ›´æ–°é¡¯ç¤º
                if (document.getElementById('indexSelect').value === 'hci') {
                    const selectedZip = document.getElementById('zipSelect').value;
                    if (selectedZip) {
                        loadZipCodeData(selectedZip);
                    }
                }
            });
            
            // æ›´æ–° w2
            w2Slider.addEventListener('input', (e) => {
                const w2 = parseInt(e.target.value) / 100;
                const w1 = 1 - w2;
                currentHCIWeights.w1 = w1;
                currentHCIWeights.w2 = w2;
                
                document.getElementById('w2Value').textContent = (w2 * 100).toFixed(0) + '%';
                document.getElementById('w1Value').textContent = (w1 * 100).toFixed(0) + '%';
                w1Slider.value = (w1 * 100).toFixed(0);
                
                // å¦‚æœç•¶å‰é¸æ“‡çš„æ˜¯ HCIï¼Œæ›´æ–°é¡¯ç¤º
                if (document.getElementById('indexSelect').value === 'hci') {
                    const selectedZip = document.getElementById('zipSelect').value;
                    if (selectedZip) {
                        loadZipCodeData(selectedZip);
                    }
                }
            });
            
            // æ›´æ–° alpha
            alphaSlider.addEventListener('input', (e) => {
                currentHCIWeights.alpha = parseInt(e.target.value) / 100;
                document.getElementById('alphaValue').textContent = (currentHCIWeights.alpha * 100).toFixed(0) + '%';
                
                // å¦‚æœç•¶å‰é¸æ“‡çš„æ˜¯ HCIï¼Œæ›´æ–°é¡¯ç¤º
                if (document.getElementById('indexSelect').value === 'hci') {
                    const selectedZip = document.getElementById('zipSelect').value;
                    if (selectedZip) {
                        loadZipCodeData(selectedZip);
                    }
                }
            });
        }
        
        // é‡æ–°è¨ˆç®—æ‰€æœ‰ ZIP Code çš„ HCI
        function recalculateAllHCI() {
            if (!allData || !allData.data) return;
            
            allHCIResults = hciCalculator.calculateAllHCI(allData.data, currentHCIWeights);
            console.log('âœ… å·²é‡æ–°è¨ˆç®—æ‰€æœ‰ ZIP Code çš„ HCI', allHCIResults);
        }
        
        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        loadData();
    </script>
</body>
</html>

